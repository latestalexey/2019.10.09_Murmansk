<?xml version="1.0" encoding="utf-8"?><Operation xmlns:clr="http://schemas.cleverence.ru/clr" comment="sh" fullscreen="Inherit" lock="No" name="ОтборСтрокРезерва" serverHosted="True"><Actions capacity="16" count="16"><ConditionAction breakPoint="False" comment="При включенном флаге проверки резерва" expression="ПроверкаРезерва == true &amp;&amp; Document.CreatedOnPDA == false" id="60192b21-75c1-4d63-a6ea-27205bdc2d74" indent="0" name="3" nextDirection="" noDirection="return" yesDirection="10" /><ConditionAction breakPoint="False" comment="При режиме работы с ячейками &quot;после товара&quot; мы не можем определить нужный нам остаток из таблицы резерва до тех пор, пока не введем ячейку" expression="GlobalVars.РежимРаботыПоЯчейкам[Document.DocumentType.Name] == &quot;после товара&quot;" id="982c3e79-8fd4-4b62-9b2c-33b2427ea3ef" indent="0" name="10" nextDirection="" noDirection="4" yesDirection="11" /><ConditionAction breakPoint="False" comment="Если склад не заполнен" expression="Document.ИдСклада1С != &quot;&quot; || Document.ИдСклада1СОткуда != &quot;&quot;" id="153c478d-4711-4956-8c23-01a353de131d" indent="1" name="4" nextDirection="" noDirection="5 1" yesDirection="5" /><SelectDocumentLinesAction breakPoint="False" id="6bc882b5-dc2b-4887-9efb-c5826fb39336" indent="2" name="5" nextDirection="12" sessionVariable="ОтборСтрокРезерва"><Query copySelection="False" documentLines="Declared" from="Резерв" sourceWhereExpression="" tableAlias="{Резерв}" useTableAliasForItem="False" whereCompiled="False" whereExpression="Item.ИдДокумента == Document.Id &amp;&amp; (Item.ИдСклада == Document.ИдСклада1С || Item.ИдСклада == Document.ИдСклада1СОткуда) &amp;&amp; Item.ИдТовара == SelectedProduct.Product.Id &amp;&amp; Item.ИдХарактеристики == SelectedProduct.ИдХарактеристики &amp;&amp; Item.ИдСерии == SelectedProduct.ИдСерии &amp;&amp; Item.ИдЯчейки == SelectedProduct.FirstStorageId"><Fields count="0" /><GroupBy capacity="8" count="6"><String>ИдДокумента</String><String>ИдСклада</String><String>ИдТовара</String><String>ИдХарактеристики</String><String>ИдСерии</String><String>ИдЯчейки</String></GroupBy><QueryParameters count="0" /><SortBy count="0" /><Where count="0" /><WhereRootElement>null</WhereRootElement></Query></SelectDocumentLinesAction><SelectDocumentLinesAction breakPoint="False" id="5cd7d130-0037-4e17-8877-9887593effbb" indent="2" name="5 1" nextDirection="12" sessionVariable="ОтборСтрокРезерва"><Query copySelection="False" documentLines="Declared" from="Резерв" sourceWhereExpression="" tableAlias="{Резерв}" useTableAliasForItem="False" whereCompiled="False" whereExpression="Item.ИдДокумента == Document.Id &amp;&amp; Item.ИдСклада == &quot;&quot;&amp;&amp; Item.ИдТовара == SelectedProduct.Product.Id &amp;&amp; Item.ИдХарактеристики == SelectedProduct.ИдХарактеристики &amp;&amp; Item.ИдСерии == SelectedProduct.ИдСерии &amp;&amp; Item.ИдЯчейки == SelectedProduct.FirstStorageId"><Fields count="0" /><GroupBy capacity="8" count="6"><String>ИдДокумента</String><String>ИдСклада</String><String>ИдТовара</String><String>ИдХарактеристики</String><String>ИдСерии</String><String>ИдЯчейки</String></GroupBy><QueryParameters count="0" /><SortBy count="0" /><Where count="0" /><WhereRootElement>null</WhereRootElement></Query></SelectDocumentLinesAction><ConditionAction breakPoint="False" comment="Если резерв был найден" expression="ОтборСтрокРезерва.Count != 0" id="38d76758-fb89-49fa-b28d-8ea8bff07886" indent="2" name="12" nextDirection="" noDirection="20" yesDirection="6" /><AssignAction breakPoint="False" comment="//При прерывании операции возвращается ErrorMessage" expression="ErrorMessage = &quot;не найдено&quot;" id="920cd83c-19ab-480a-8c05-e8f37af60d2b" indent="3" name="20" nextDirection="abort" /><ConditionAction breakPoint="False" expression="(СтрокиТекущегоТовара.CurrentQuantity)&gt;= (ОтборСтрокРезерва[0].Остаток + ОтборСтрокРезерва[0].Резерв)" id="102e66ad-6168-40aa-98cb-b5e3dde8e294" indent="3" name="6" nextDirection="" noDirection="return" yesDirection="21" /><AssignAction breakPoint="False" comment="//При прерывании операции возвращается ErrorMessage" expression="ErrorMessage = &quot;нет в резерве&quot;" id="15287fe5-9634-42e4-b954-be2a80a364a7" indent="4" name="21" nextDirection="abort" /><ConditionAction breakPoint="False" expression="Document.ИдСклада1С != &quot;&quot; || Document.ИдСклада1СОткуда != &quot;&quot;" id="06f6f1fb-9e72-4569-82d4-6cbe23dfa08a" indent="1" name="11" nextDirection="" noDirection="13" yesDirection="16" /><SelectDocumentLinesAction breakPoint="False" id="0ef5d8fa-82a2-4434-a50b-3c7cc9fc5454" indent="2" name="13" nextDirection="14" sessionVariable="ОтборСтрокРезерва"><Query copySelection="False" documentLines="Declared" from="Резерв" sourceWhereExpression="" tableAlias="Резерв" useTableAliasForItem="False" whereCompiled="False" whereExpression="Item.ИдДокумента == Document.Id &amp;&amp; Item.ИдСклада == &quot;&quot; &amp;&amp; Item.ИдТовара == SelectedProduct.Product.Id &amp;&amp; Item.ИдХарактеристики == SelectedProduct.ИдХарактеристики &amp;&amp; Item.ИдСерии == SelectedProduct.ИдСерии &amp;&amp; Item.ИдЯчейки != &quot;&quot;"><Fields count="0" /><GroupBy capacity="8" count="5"><String>ИдДокумента</String><String>ИдСклада</String><String>ИдТовара</String><String>ИдХарактеристики</String><String>ИдСерии</String></GroupBy><QueryParameters count="0" /><SortBy count="0" /><Where count="0" /><WhereRootElement>null</WhereRootElement></Query></SelectDocumentLinesAction><SelectDocumentLinesAction breakPoint="False" id="a72985d9-cda9-4dce-ad33-7b2e692d879e" indent="2" name="16" nextDirection="14" sessionVariable="ОтборСтрокРезерва"><Query copySelection="False" documentLines="Declared" from="Резерв" sourceWhereExpression="" tableAlias="Резерв" useTableAliasForItem="False" whereCompiled="False" whereExpression="Item.ИдДокумента == Document.Id &amp;&amp; (Item.ИдСклада == Document.ИдСклада1С || Item.ИдСклада == Document.ИдСклада1СОткуда) &amp;&amp; Item.ИдТовара == SelectedProduct.Product.Id &amp;&amp; Item.ИдХарактеристики == SelectedProduct.ИдХарактеристики &amp;&amp; Item.ИдСерии == SelectedProduct.ИдСерии &amp;&amp; Item.ИдЯчейки != &quot;&quot;"><Fields count="0" /><GroupBy capacity="8" count="5"><String>ИдДокумента</String><String>ИдСклада</String><String>ИдТовара</String><String>ИдХарактеристики</String><String>ИдСерии</String></GroupBy><QueryParameters count="0" /><SortBy count="0" /><Where count="0" /><WhereRootElement>null</WhereRootElement></Query></SelectDocumentLinesAction><ConditionAction breakPoint="False" comment="Нашлась ли вообще какая-нибудь позиция для данного товара" expression="ОтборСтрокРезерва.Count != 0" id="16253d1f-9490-4df9-a726-f51394c61d19" indent="2" name="14" nextDirection="" noDirection="20" yesDirection="18" /><ConditionAction breakPoint="False" comment="Если найдена всего одна строка резерва, переходим к упрощённой схеме" expression="ОтборСтрокРезерва.Count == 1" id="922a77ae-eaac-4eb5-ac7e-6f0f8bca2aed" indent="3" name="18" nextDirection="" noDirection="17" yesDirection="19" /><AssignAction breakPoint="False" expression="MaxQty = ОтборСтрокРезерва[0].Резерв + ОтборСтрокРезерва[0].Остаток" id="88509e0f-c8ce-4d34-806e-e504d80636e3" indent="4" name="19" nextDirection="return" /><AssignAction breakPoint="False" comment="Возможно, лишнее" expression="MaxQty = 0;&#xD;&#xA;i = 0;&#xD;&#xA;While (i&lt;ОтборСтрокРезерва.Count)&#xD;&#xA;{&#xD;&#xA;If(MaxQty&lt;(ОтборСтрокРезерва[i].Резерв + ОтборСтрокРезерва[i].Остаток))&#xD;&#xA;{&#xD;&#xA;MaxQty = ОтборСтрокРезерва[i].Резерв + ОтборСтрокРезерва[i].Остаток;&#xD;&#xA;}&#xD;&#xA;i=i+1;&#xD;&#xA;}" id="7670fac0-0903-49f6-93be-0efcab6ed4f6" indent="4" name="17" nextDirection="return" /></Actions><Parameters count="3"><FieldInfo alias="" eanAI="None" fieldName="SelectedProduct" fieldType="Object" isSQLIndex="False" isSQLKeyIndex="False" isSQLSubstringIndex="False" oneTimeTemplateExecution="False" uni="SelectedProduct" valueTemplate="" /><FieldInfo alias="" eanAI="None" fieldName="ПроверкаРезерва" fieldType="Boolean" isSQLIndex="False" isSQLKeyIndex="False" isSQLSubstringIndex="False" oneTimeTemplateExecution="False" uni="ProverkaRezerva" valueTemplate="" /><FieldInfo alias="" eanAI="None" fieldName="СтрокиТекущегоТовара" fieldType="Object" isSQLIndex="False" isSQLKeyIndex="False" isSQLSubstringIndex="False" oneTimeTemplateExecution="False" uni="StrokiTekushhegoTovara" valueTemplate="" /></Parameters><Returns count="4"><ReturnFieldInfo alias="" eanAI="None" fieldName="ОтборСтрокРезерва" fieldType="Object" isSQLIndex="False" isSQLKeyIndex="False" isSQLSubstringIndex="False" oneTimeTemplateExecution="False" returnNull="False" uni="OtborStrokRezerva" valueTemplate="" /><ReturnFieldInfo alias="" eanAI="None" fieldName="SelectedProduct" fieldType="Object" isSQLIndex="False" isSQLKeyIndex="False" isSQLSubstringIndex="False" oneTimeTemplateExecution="False" returnNull="False" uni="SelectedProduct" valueTemplate="" /><ReturnFieldInfo alias="" eanAI="None" fieldName="СтрокиТекущегоТовара" fieldType="Object" isSQLIndex="False" isSQLKeyIndex="False" isSQLSubstringIndex="False" oneTimeTemplateExecution="False" returnNull="False" uni="StrokiTekushhegoTovara" valueTemplate="" /><ReturnFieldInfo alias="" eanAI="None" fieldName="MaxQty" fieldType="Decimal" isSQLIndex="False" isSQLKeyIndex="False" isSQLSubstringIndex="False" oneTimeTemplateExecution="False" returnNull="False" uni="MaxQty" valueTemplate="" /></Returns></Operation>